import static java.lang.Boolean.valueOf

task unitTest(type: Test) {
    useJUnitPlatform {
        includeTags "UnitTest"
    }
    description = "Execute unit tests."
    group = "verification"
}

task integrationTest(type: Test) {
    useJUnitPlatform {
        includeTags "IntegrationTest"
    }
    description = "Execute integration tests."
    group = "verification"

    doFirst {dockerCompose.exposeAsEnvironment(integrationTest)}
}

dockerCompose {
    useComposeFiles.add("docker/test/docker-compose.yml")
    isRequiredBy(project.tasks.integrationTest)
}

test {
    def tasks = []
    !valueOf(runUnitTest) ?: tasks.add(unitTest)
    !valueOf(runIntegrationTest) ?: tasks.add(integrationTest)
    for (int i = 0; i < tasks.size() - 1; i++) {
        tasks[i + 1].mustRunAfter(tasks[i])
    }
    dependsOn tasks
}

assemble.dependsOn test
